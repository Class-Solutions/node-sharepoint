"use strict";var _=require("lodash"),fs=require("fs"),qs=require("querystring"),xml2js=require("xml2js"),http=require("http"),https=require("https"),urlparse=require("url").parse,samlRequestTemplate='<s:Envelope xmlns:s="http://www.w3.org/2003/05/soap-envelope" xmlns:a="http://www.w3.org/2005/08/addressing" xmlns:u="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"><s:Header><a:Action s:mustUnderstand="1">http://schemas.xmlsoap.org/ws/2005/02/trust/RST/Issue</a:Action><a:ReplyTo><a:Address>http://www.w3.org/2005/08/addressing/anonymous</a:Address></a:ReplyTo><a:To s:mustUnderstand="1">https://login.microsoftonline.com/extSTS.srf</a:To><o:Security s:mustUnderstand="1" xmlns:o="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd"><o:UsernameToken><o:Username>[username]</o:Username><o:Password>[password]</o:Password></o:UsernameToken></o:Security></s:Header><s:Body><t:RequestSecurityToken xmlns:t="http://schemas.xmlsoap.org/ws/2005/02/trust"><wsp:AppliesTo xmlns:wsp="http://schemas.xmlsoap.org/ws/2004/09/policy"><a:EndpointReference><a:Address>[endpoint]</a:Address></a:EndpointReference></wsp:AppliesTo><t:KeyType>http://schemas.xmlsoap.org/ws/2005/05/identity/NoProofKey</t:KeyType><t:RequestType>http://schemas.xmlsoap.org/ws/2005/02/trust/Issue</t:RequestType><t:TokenType>urn:oasis:names:tc:SAML:1.0:assertion</t:TokenType></t:RequestSecurityToken></s:Body></s:Envelope>',SP;!function(t){var e=function(){function t(t,e,s){this.List=t,this.Accept=e,this.Method=s}return t}(),s=function(){function t(t,e){this.Name=t,this.Value=e}return t}(),n=function(){function n(t){this.Url=urlparse(t),this.Host=this.Url.host,this.Path=this.Url.path,this.Protocol=this.Url.protocol,this.STS={Host:"login.microsoftonline.com",Path:"/extSTS.srf"},this.Login="/_forms/default.aspx?wa=wsignin1.0",this.ODataEndPoint="/_vti_bin/ListData.svc/"}return n.prototype.SignIn=function(t,e,s){var o=this,r={username:t,password:e,sts:o.STS,endpoint:o.Url.protocol+"//"+o.Url.hostname+o.Login};n._RequestToken(r,function(t,e){return t?void s(t,null):(o.FedAuth=e.FedAuth,o.rtFa=e.rtFa,void s(null,e))})},n.prototype.GetList=function(e){var s=new t.List(this,e);return s},n.prototype.Request=function(t,e){var s=t.data||"",n=t.list,o=t.id,r=t.query,a="https:"==this.Protocol,i=this.Path+this.ODataEndPoint+n+(o?"("+o+")":"")+(r?"?"+qs.stringify(r):""),u={method:t.method,host:this.Host,path:i,headers:{Accept:t.accept||"application/json","Content-type":"application/json",Cookie:"FedAuth="+this.FedAuth+"; rtFa="+this.rtFa,"Content-length":s.length,"If-Match":""}};t.etag&&(u.headers["If-Match"]=t.etag);var p=a?https:http,d=p.request(u,function(t){var s="";t.setEncoding("utf8"),t.on("data",function(t){s+=t}),t.on("end",function(){e&&(s&&t.headers["content-type"].indexOf("json")>0&&(s=JSON.parse(s).d),s?e(null,s):e(null,null))})});d.end(s)},n.prototype.Metadata=function(t){var s=new e("$metadata","application/xml","GET");this.Request(s,t)},n._BuildSamlRequest=function(t){var e=samlRequestTemplate;for(var s in t)e=e.replace("["+s+"]",t[s]);return console.log(e),e},n._ParseXml=function(t,e){var s=new xml2js.Parser({emptyTag:""});s.on("end",function(t){e&&e(t)}),s.parseString(t)},n._ParseCookie=function(t){var e=t.split("; "),n=new s("","");return e.forEach(function(t,e){var s=t.indexOf("="),o=s>0?t.substring(0,s):t,r=s>0?t.substring(s+1):void 0;0===e?(n.Name=o,n.Value=r):n.Name=r}),n},n._ParseCookies=function(t){var e=this,s=new Array;return t&&t.forEach(function(t){var n=e._ParseCookie(t);s.push(n)}),s},n._GetCookie=function(t,e){for(var s,n=t.length,o=0;n>o;o++)if(s=t[o],s.name==e)return s;return void 0},n._SubmitToken=function(t,e){var s=t.token,o=urlparse(t.endpoint),r="https:"==o.protocol,a={method:"POST",host:o.hostname,path:o.path,headers:{"User-Agent":"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)"}},i=r?https:http,u=i.request(a,function(t){var s="";t.setEncoding("utf8"),t.on("data",function(t){s+=t}),t.on("end",function(){var s=n._ParseCookies(t.headers["set-cookie"]);e(null,{FedAuth:n._GetCookie(s,"FedAuth").value,rtFa:n._GetCookie(s,"rtFa").value})})});u.end(s)},n._RequestToken=function(t,e){var s=n._BuildSamlRequest({username:t.username,password:t.password,endpoint:t.endpoint});fs.writeFileSync("C:\\Data.txt",s);var o={method:"POST",host:t.sts.Host,path:t.sts.Path,headers:{"Content-Length":Buffer.byteLength(s.length)}},r=https.request(o,function(s){var o="";s.setEncoding("utf8"),s.on("data",function(t){o+=t}),s.on("end",function(){n._ParseXml(o,function(s){var o=_.get(s,"S:Envelope.S:Body[0].S:Fault[0]");if(o){var r=_.get(o,"S:Detail[0].psf:error[0].psf:internalerror[0]"),a=_.get(r,"psf:text[0]"),i=_.get(r,"psf:code");return void e(i+" "+a,null)}var u=s["S:Envelope"]["S:Body"]["wst:RequestSecurityTokenResponse"]["wst:RequestedSecurityToken"]["wsse:BinarySecurityToken"]["#"];n._SubmitToken({token:u,endpoint:t.endpoint},e)})})});r.end(s)},n}();t.RestService=n;var o=function(){function t(t,e){}return t}();t.List=o}(SP||(SP={})),module.exports=SP;