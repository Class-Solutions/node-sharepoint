"use strict";function requestToken(t,e){var n=buildSamlRequest({username:t.username,password:t.password,endpoint:t.endpoint}),s={method:"POST",host:t.sts.host,path:t.sts.path,headers:{"Content-Length":n.length}},i=https.request(s,function(n){var s="";n.setEncoding("utf8"),n.on("data",function(t){s+=t}),n.on("end",function(){parseXml(s,function(n){if(n["S:Envelope"]["S:Body"][0]&&n["S:Envelope"]["S:Body"][0]["S:Fault"]){var s=n["S:Envelope"]["S:Body"][0]["S:Fault"][0]["S:Detail"]["psf:error"]["psf:internalerror"]["psf:text"];return void e(s)}var i=n["S:Envelope"]["S:Body"]["wst:RequestSecurityTokenResponse"]["wst:RequestedSecurityToken"]["wsse:BinarySecurityToken"]["#"];submitToken({token:i,endpoint:t.endpoint},e)})})});i.end(n)}function submitToken(t,e){var n=t.token,s=urlparse(t.endpoint),i="https:"==s.protocol,o={method:"POST",host:s.hostname,path:s.path,headers:{"User-Agent":"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)"}},r=i?https:http,a=r.request(o,function(t){var n="";t.setEncoding("utf8"),t.on("data",function(t){n+=t}),t.on("end",function(){var n=parseCookies(t.headers["set-cookie"]);e(null,{FedAuth:getCookie(n,"FedAuth").value,rtFa:getCookie(n,"rtFa").value})})});a.end(n)}function signin(t,e,n){var s=this,i={username:t,password:e,sts:s.sts,endpoint:s.url.protocol+"//"+s.url.hostname+s.login};requestToken(i,function(t,e){return t?void n(t):(s.FedAuth=e.FedAuth,s.rtFa=e.rtFa,void n(null,e))})}function request(t,e){var n=t.data||"",s=t.list,i=t.id,o=t.query,r="https:"==this.protocol,a=this.path+this.odatasvc+s+(i?"("+i+")":"")+(o?"?"+qs.stringify(o):""),u={method:t.method,host:this.host,path:a,headers:{Accept:t.accept||"application/json","Content-type":"application/json",Cookie:"FedAuth="+this.FedAuth+"; rtFa="+this.rtFa,"Content-length":n.length}};t.etag&&(u.headers["If-Match"]=t.etag);var d=r?https:http,h=d.request(u,function(t){var n="";t.setEncoding("utf8"),t.on("data",function(t){n+=t}),t.on("end",function(){e&&(n&&t.headers["content-type"].indexOf("json")>0&&(n=JSON.parse(n).d),n?e(null,n):e())})});h.end(n)}function get(t,e){var n,s,i;"object"==typeof t&&(s=t,i=e),("string"==typeof t||"number"==typeof t)&&(n=t,i=e),e||(i=t);var o={list:this.name,id:n,query:s,method:"GET"};this.service.request(o,i)}function add(t,e){var n={list:this.name,method:"POST",data:JSON.stringify(t)};this.service.request(n,e)}function del(t,e){var n={list:this.name,id:t,method:"DELETE"};this.service.request(n,e)}function update(t,e,n){var s={list:this.name,id:t,method:"MERGE",etag:e.__metadata.etag,data:JSON.stringify(e)};this.service.request(s,n)}function list(t){var e=new SP.List(this,t);return e}function metadata(t){var e={list:"$metadata",accept:"application/xml",method:"GET"};this.request(e,t)}var fs=require("fs"),qs=require("querystring"),xml2js=require("xml2js"),http=require("http"),https=require("https"),urlparse=require("url").parse,samlRequestTemplate=fs.readFileSync(__dirname+"/SAML.xml","utf8"),buildSamlRequest=function(t){var e,n=samlRequestTemplate;for(e in t)n=n.replace("["+e+"]",t[e]);return n},parseXml=function(t,e){var n=new xml2js.Parser({emptyTag:""});n.on("end",function(t){e&&e(t)}),n.parseString(t)},parseCookie=function(t){var e=t.split("; "),n={name:"",value:""};return e.forEach(function(t,e){var s=t.indexOf("="),i=s>0?t.substring(0,s):t,o=s>0?t.substring(s+1):void 0;0===e?(n.name=i,n.value=o):n[i]=o}),n},parseCookies=function(t){var e=[];return t&&t.forEach(function(t){var n=parseCookie(t);e.push(n)}),e},getCookie=function(t,e){for(var n,s=0,i=t.length;i>s;s++)if(n=t[s],n.name==e)return n;return void 0},SP={List:null,RestService:null};SP.RestService=function(t){this.url=urlparse(t),this.host=this.url.host,this.path=this.url.path,this.protocol=this.url.protocol,this.sts={host:"login.microsoftonline.com",path:"/extSTS.srf"},this.login="/_forms/default.aspx?wa=wsignin1.0",this.odatasvc="/_vti_bin/ListData.svc/"},SP.RestService.prototype={signin:signin,list:list,request:request,metadata:metadata},SP.List=function(t,e){this.service=t,this.name=e},SP.List.prototype={get:get,add:add,update:update,del:del},module.exports=SP;